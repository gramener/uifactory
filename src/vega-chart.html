<template $name="vega-chart" spec:urljson="" $render:js="() => {}">
  <script>
    uifactory.vegaChart = {
      updateSignal: function () {
        let signalChange = false
        // For every attribute in <vega-chart>
        for (let [key, value] of Object.entries(this.$data)) {
          // Check all signals in the spec
          (this.$spec.signals || []).some(signal => {
            // ... to find a signal with the same name, but different value
            if (signal.name == key && this.$view.signal(key) != value) {
              // Update that signal value
              this.$view.signal(key, value)
              return signalChange = true
            }
          })
        }
        return signalChange
      },
      // TODO: xaxis needs different defaults from yaxis
      types: {
        "axis": [
          // { "name": "scale", "value": null, "type": null },
          { "name": "orient", "value": "bottom", "type": null },
          { "name": "bandPosition", "value": null, "type": null },
          { "name": "domain", "value": null, "type": null },
          { "name": "domainCap", "value": null, "type": null },
          { "name": "domainColor", "value": "black", "type": null },
          { "name": "domainDash", "value": null, "type": null },
          { "name": "domainDashOffset", "value": null, "type": null },
          { "name": "domainOpacity", "value": null, "type": null },
          { "name": "domainWidth", "value": null, "type": null },
          { "name": "encode", "value": null, "type": null },
          { "name": "format", "value": null, "type": null },
          { "name": "formatType", "value": null, "type": null },
          // TODO: grid signal is not working
          { "name": "grid", "value": null, "type": "boolean" },
          { "name": "gridCap", "value": null, "type": null },
          { "name": "gridColor", "value": "black", "type": "color" },
          { "name": "gridDash", "value": null, "type": null },
          { "name": "gridDashOffset", "value": null, "type": null },
          { "name": "gridOpacity", "value": 0.1, "type": "number" },
          // TODO: gridScale is the name of a scale. Default is same as scale
          // { "name": "gridScale", "value": null, "type": null },
          { "name": "gridWidth", "value": null, "type": null },
          // TODO: labels signal is not working
          { "name": "labels", "value": true, "type": "boolean" },
          { "name": "labelAlign", "value": "center", "type": "text" },
          { "name": "labelAngle", "value": null, "type": null },
          { "name": "labelBaseline", "value": "top", "type": null },
          { "name": "labelBound", "value": null, "type": null },
          { "name": "labelColor", "value": "black", "type": "color" },
          { "name": "labelFlush", "value": null, "type": null },
          { "name": "labelFlushOffset", "value": null, "type": null },
          { "name": "labelFont", "value": null, "type": null },
          { "name": "labelFontSize", "value": null, "type": "number" },
          { "name": "labelFontStyle", "value": null, "type": null },
          { "name": "labelFontWeight", "value": null, "type": null },
          { "name": "labelLimit", "value": null, "type": null },
          { "name": "labelLineHeight", "value": null, "type": null },
          { "name": "labelOffset", "value": null, "type": null },
          { "name": "labelOpacity", "value": null, "type": "number" },
          { "name": "labelOverlap", "value": null, "type": null },
          { "name": "labelPadding", "value": 2, "type": "number" },
          { "name": "labelSeparation", "value": null, "type": null },
          { "name": "minExtent", "value": null, "type": null },
          { "name": "maxExtent", "value": null, "type": null },
          { "name": "offset", "value": null, "type": null },
          { "name": "position", "value": null, "type": null },
          { "name": "ticks", "value": null, "type": null },
          { "name": "tickBand", "value": null, "type": null },
          { "name": "tickCap", "value": null, "type": null },
          { "name": "tickColor", "value": "black", "type": "color" },
          { "name": "tickCount", "value": null, "type": null },
          { "name": "tickDash", "value": null, "type": null },
          { "name": "tickDashOffset", "value": null, "type": null },
          { "name": "tickMinStep", "value": null, "type": null },
          { "name": "tickExtra", "value": null, "type": null },
          { "name": "tickOffset", "value": null, "type": null },
          { "name": "tickOpacity", "value": null, "type": null },
          { "name": "tickRound", "value": null, "type": null },
          { "name": "tickSize", "value": 5, "type": null },
          { "name": "tickWidth", "value": null, "type": null },
          { "name": "title", "value": null, "type": "text" },
          { "name": "titleAnchor", "value": "end", "type": null },
          { "name": "titleAlign", "value": "right", "type": "text" },
          { "name": "titleAngle", "value": null, "type": null },
          { "name": "titleBaseline", "value": "bottom", "type": null },
          { "name": "titleColor", "value": "black", "type": "color" },
          { "name": "titleFont", "value": null, "type": null },
          { "name": "titleFontSize", "value": null, "type": null },
          { "name": "titleFontStyle", "value": null, "type": null },
          { "name": "titleFontWeight", "value": null, "type": "number" },
          { "name": "titleLimit", "value": null, "type": null },
          { "name": "titleLineHeight", "value": null, "type": "number" },
          { "name": "titleOpacity", "value": null, "type": "number" },
          { "name": "titlePadding", "value": -5, "type": "number" },
          // TODO: Setting titleX, titleY overrides positioning
          // { "name": "titleX", "value": null, "type": null },
          // { "name": "titleY", "value": null, "type": null },
          { "name": "translate", "value": null, "type": null },
          { "name": "values", "value": null, "type": null },
          { "name": "zindex", "value": 1, "type": "number" }
        ],
        "mark.rect": [
          { "name": "cornerRadius", "value": null, "type": "number" },
          { "name": "cornerRadiusTopLeft", "value": null, "type": "number" },
          { "name": "cornerRadiusTopRight", "value": null, "type": "number" },
          { "name": "cornerRadiusBottomLeft", "value": null, "type": "number" },
          { "name": "cornerRadiusBottomRight", "value": null, "type": "number" },
          // { "name": "x", "value": null, "type": "number" },
          // { "name": "x2", "value": null, "type": "number" },
          // { "name": "xc", "value": null, "type": "number" },
          // { "name": "width", "value": null, "type": "number" },
          // { "name": "y", "value": null, "type": "number" },
          // { "name": "y2", "value": null, "type": "number" },
          // { "name": "yc", "value": null, "type": "number" },
          // { "name": "height", "value": null, "type": "number" },
          { "name": "opacity", "value": null, "type": "number" },
          { "name": "fill", "value": null, "type": "text" },
          { "name": "fillOpacity", "value": null, "type": "number" },
          { "name": "stroke", "value": null, "type": "text" },
          { "name": "strokeOpacity", "value": null, "type": "number" },
          { "name": "strokeWidth", "value": null, "type": "number" },
          { "name": "strokeCap", "value": null, "type": "text" },
          { "name": "strokeDash", "value": null, "type": "text" },
          { "name": "strokeDashOffset", "value": null, "type": "number" },
          { "name": "strokeJoin", "value": null, "type": "text" },
          { "name": "strokeMiterLimit", "value": null, "type": "text" },
          { "name": "blend", "value": null, "type": "text" },
          { "name": "cursor", "value": null, "type": "text" },
          { "name": "href", "value": null, "type": "text" },
          { "name": "tooltip", "value": null, "type": null },
          { "name": "zindex", "value": null, "type": "number" },
        ]
      }
    }
  </script>
  <script onrender data-once>
    /* globals vega, vegaLite */
    // If there's no spec, treat it as empty spec and process it from
    // Deep clone the spec to avoid changing original when we update it.
    let spec = this.$spec = this.spec ? JSON.parse(JSON.stringify(this.spec)) : {}
    // Evaluate all scripts inside <template><script>... in the context of spec.
    // "this" becomes the node. "spec" is also available as a variable.
    for (let tmpl of this.querySelectorAll('template')) {
      for (let script of tmpl.content.querySelectorAll('script')) {
        let update_spec = new Function('spec', script.innerHTML)
        update_spec.call(this, spec)
      }
    }

    // If the spec is vega-lite, convert it to Vega.
    // Vega-lite $schema is "https://vega.github.io/schema/vega-lite/v5.json".
    if (spec.$schema && spec.$schema.match(/vega-lite/))
      spec = vegaLite.compile(spec).spec

    // Add signals
    if (spec.uifactoryConfig) {
      let signals = spec.signals = spec.signals || []
      spec.uifactoryConfig.forEach(config => {
        // TODO: Avoid lodash
        let insertion = _.get(spec, config.insert)
        uifactory.vegaChart.types[config.type].forEach(row => {
          let name = config.prefix + row.name.charAt(0).toUpperCase() + row.name.substr(1)
          let value = row.name in insertion ? insertion[row.name] : row.value
          if (typeof value == 'object' && value && 'value' in value)
            value = value.value
          signals.push({ name, value, type: row.type })
          insertion[row.name] = { signal: name }
        })
      })
    }

    // Render the chart. Store the view in the node's .ui object
    this.$view = new vega.View(vega.parse(spec), { renderer: 'svg', container: this })
    // Update with signals
    uifactory.vegaChart.updateSignal.call(this)
    this.$view.runAsync()
  </script>
  <script onrender>
    // If any signal has been changed, re-render the chart and exit
    // Never re-render unless the spec has changed
    if (uifactory.vegaChart.updateSignal.call(this))
      this.$view.runAsync()
  </script>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
</template>
