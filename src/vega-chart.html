<template $name="vega-chart" $render:js="uifactory.vegaChart.draw" spec:urljson="">
  <script>
    uifactory.vegaChart = {
      /* globals vega, vegaLite */
      updateSignal: function (node) {
        let signalChange = false
        // For every attribute in <vega-chart>
        for (let [key, value] of Object.entries(node.data)) {
          // Check all signals in the spec
          (node.$.spec.signals || []).some(signal => {
            // ... to find a signal with the same name, but different value
            if (signal.name == key && node.$.view.signal(key) != value) {
              // Update that signal value
              node.$.view.signal(key, value)
              return signalChange = true
            }
          })
        }
        return signalChange
      },
      draw: node => {
        // If we've already created the chart, only update the signals. Never re-render
        // unless the spec has changed
        if (node.$.view) {
          // If any signal has been changed, re-render the chart and exit
          if (uifactory.vegaChart.updateSignal(node))
            node.$.view.runAsync()
          return
        }

        // If there's no spec, treat it as empty spec and process it from
        // Deep clone the spec to avoid changing original when we update it.
        let spec = node.$.spec = node.data.spec ? JSON.parse(JSON.stringify(node.data.spec)) : {}
        // Evaluate all scripts inside <template><script>... in the context of spec.
        // "this" becomes the node. "spec" is also available as a variable.
        for (let tmpl of node.querySelectorAll('template')) {
          for (let script of tmpl.content.querySelectorAll('script')) {
            let update_spec = new Function('spec', script.innerHTML)
            update_spec.call(node, spec)
          }
        }

        // If the spec is vega-lite, convert it to Vega.
        // Vega-lite $schema is "https://vega.github.io/schema/vega-lite/v5.json".
        if (spec.$schema && spec.$schema.match(/vega-lite/))
          spec = vegaLite.compile(spec).spec

        // Render the chart. Store the view in the node's .ui object
        node.$.view = new vega.View(vega.parse(spec), { renderer: 'svg', container: node })
        // Update with signals
        uifactory.vegaChart.updateSignal(node)
        node.$.view.runAsync()
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
</template>
